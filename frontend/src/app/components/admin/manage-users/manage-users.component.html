<div class="container">
  <h1 class="page-title">Manage Users</h1>

  @if (loading && users.length === 0) {
    <div class="flex-center" style="min-height: 300px;">
      <div class="spinner"></div>
    </div>
  } @else {
    <div class="table-responsive">
      <table class="users-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Username</th>
            <th>Email</th>
            <th>Role</th>
            <th>Total Bookings</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (user of users; track user.id) {
            <tr>
              <td><span class="user-id">{{ user.id }}</span></td>
              <td>
                <div class="user-info">
                  <div class="user-avatar">{{ user.username.charAt(0).toUpperCase() }}</div>
                  <strong>{{ user.username }}</strong>
                </div>
              </td>
              <td>{{ user.email }}</td>
              <td>
                <span class="role-badge" [class.admin-role]="user.role === 'ADMIN'">
                  {{ user.role }}
                </span>
              </td>
              <td>
                <span class="bookings-count">
                  @if (user.bookingCount !== undefined) {
                    {{ user.bookingCount }} booking{{ user.bookingCount !== 1 ? 's' : '' }}
                  } @else {
                    <span class="loading-dot">Loading...</span>
                  }
                </span>
              </td>
              <td>
                <div class="action-buttons">
                  <button 
                    class="action-btn view-btn" 
                    (click)="viewBookingHistory(user)"
                    title="View Booking History">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                      <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                  </button>
                  <button 
                    class="action-btn contact-btn" 
                    (click)="contactUser(user)"
                    title="Contact User">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                      <polyline points="22,6 12,13 2,6"></polyline>
                    </svg>
                  </button>
                  <button 
                    class="action-btn gift-btn" 
                    (click)="openGiftModal(user)"
                    title="Gift Tickets">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="20 12 20 22 4 22 4 12"></polyline>
                      <rect x="2" y="7" width="20" height="5"></rect>
                      <line x1="12" y1="22" x2="12" y2="7"></line>
                      <path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"></path>
                      <path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"></path>
                    </svg>
                  </button>
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }
</div>

<!-- Booking History Modal -->
@if (showBookingsModal) {
  <div class="modal-overlay" (click)="closeBookingsModal()">
    <div class="modal-content modal-large" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Booking History - {{ selectedUser?.username }}</h2>
        <button class="close-btn" (click)="closeBookingsModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="user-summary">
          <div class="summary-item">
            <span class="summary-label">Email</span>
            <span class="summary-value">{{ selectedUser?.email }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Total Bookings</span>
            <span class="summary-value">{{ userBookings.length }}</span>
          </div>
        </div>

        @if (userBookings.length === 0) {
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            <p>No bookings found for this user</p>
          </div>
        } @else {
          <div class="bookings-list">
            @for (booking of userBookings; track booking.id) {
              <div class="booking-card">
                <div class="booking-header">
                  <div class="booking-reference">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                      <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    {{ booking.bookingReference }}
                  </div>
                  <span class="status-badge" [ngClass]="getStatusClass(booking.status)">
                    {{ booking.status }}
                  </span>
                </div>
                <div class="booking-details">
                  <div class="detail-row">
                    <span class="detail-label">Movie</span>
                    <span class="detail-value movie-title">{{ booking.show.movie.title }}</span>
                  </div>
                  <div class="detail-row">
                    <span class="detail-label">Theater</span>
                    <span class="detail-value">{{ booking.show.theater.name }}</span>
                  </div>
                  <div class="detail-row">
                    <span class="detail-label">Date & Time</span>
                    <span class="detail-value">{{ booking.show.showDate }} at {{ booking.show.showTime }}</span>
                  </div>
                  <div class="detail-row">
                    <span class="detail-label">Seats</span>
                    <span class="detail-value seats-info">{{ booking.seatsBooked }} seats</span>
                  </div>
                  <div class="detail-row">
                    <span class="detail-label">Amount</span>
                    <span class="detail-value amount">₹{{ booking.totalAmount }}</span>
                  </div>
                </div>
              </div>
            }
          </div>
        }
      </div>
    </div>
  </div>
}

<!-- Gift Ticket Modal -->
@if (showGiftModal) {
  <div class="modal-overlay" (click)="closeGiftModal()">
    <div class="modal-content modal-medium" (click)="$event.stopPropagation()">
      <div class="modal-header modal-header-gift">
        <h2>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="20 12 20 22 4 22 4 12"></polyline>
            <rect x="2" y="7" width="20" height="5"></rect>
            <line x1="12" y1="22" x2="12" y2="7"></line>
            <path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"></path>
            <path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"></path>
          </svg>
          Gift Tickets to {{ selectedUser?.username }}
        </h2>
        <button class="close-btn" (click)="closeGiftModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <form class="gift-form">
          <div class="form-group">
            <label>Select Show</label>
            <select [(ngModel)]="giftData.showId" name="showId" class="form-control" required>
              <option value="0">-- Select a show --</option>
              @for (show of availableShows; track show.id) {
                <option [value]="show.id">
                  {{ show.movie.title }} - {{ show.theater.name }} ({{ show.showDate }} {{ show.showTime }})
                </option>
              }
            </select>
          </div>

          @if (getSelectedShow()) {
            <div class="show-preview">
              <div class="preview-item">
                <span>Available Seats:</span>
                <strong>{{ getSelectedShow().availableSeats }}</strong>
              </div>
              <div class="preview-item">
                <span>Price per seat:</span>
                <strong>₹{{ getSelectedShow().price }}</strong>
              </div>
            </div>
          }

          <div class="form-group">
            <label>Number of Seats</label>
            <input 
              type="number" 
              [(ngModel)]="giftData.seatsBooked" 
              name="seatsBooked"
              class="form-control" 
              min="1" 
              [max]="getSelectedShow()?.availableSeats || 1"
              required>
          </div>

          <div class="form-group">
            <label>Gift Message (Optional)</label>
            <textarea 
              [(ngModel)]="giftData.message" 
              name="message"
              class="form-control" 
              rows="3"
              placeholder="Add a personalized message..."></textarea>
          </div>

          @if (getSelectedShow()) {
            <div class="total-amount">
              Total: ₹{{ getSelectedShow().price * giftData.seatsBooked }}
            </div>
          }

          <div class="form-actions">
            <button type="button" class="btn btn-outline" (click)="closeGiftModal()">Cancel</button>
            <button type="button" class="btn btn-gift" (click)="sendGiftTicket()" [disabled]="!giftData.showId || loading">
              @if (loading) {
                <span class="spinner-small"></span>
              }
              Send Gift Ticket
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
}
