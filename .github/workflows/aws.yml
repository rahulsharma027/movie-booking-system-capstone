name: Deploy to EC2

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  EC2_HOST: ${{ secrets.EC2_HOST }}
  EC2_USER: ec2-user
  DOCKER_IMAGE_FRONTEND: cinenow-frontend
  DOCKER_IMAGE_BACKEND: cinenow-backend

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
   
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
   
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
   
    - name: Build Frontend Docker Image
      working-directory: ./frontend
      run: |
        docker build -t ${{ env.DOCKER_IMAGE_FRONTEND }}:latest .
   
    - name: Build Backend Docker Image
      working-directory: ./backend
      run: |
        docker build -t ${{ env.DOCKER_IMAGE_BACKEND }}:latest .
   
    - name: Save Docker Images
      run: |
        docker save ${{ env.DOCKER_IMAGE_FRONTEND }}:latest | gzip > frontend.tar.gz
        docker save ${{ env.DOCKER_IMAGE_BACKEND }}:latest | gzip > backend.tar.gz
   
    - name: Copy files to EC2
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ env.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        source: "frontend.tar.gz,backend.tar.gz,docker-compose.yml,.env.production"
        target: "/home/ec2-user/cinenow"
   
    - name: Deploy to EC2
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ env.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          cd /home/ec2-user/cinenow
          docker load < frontend.tar.gz
          docker load < backend.tar.gz
          docker-compose down
          docker-compose up -d
          docker system prune -f
